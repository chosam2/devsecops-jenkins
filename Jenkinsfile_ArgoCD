pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: aws-kubectl
    image: atlastechnologiesteam/aws-cli-kubectl-base:aws-cli-2.13.5-r0-kubectl-1.27.0
    command:
    - /bin/sh
    args:
    - -c
    - cat
    tty: true
'''
        }
    }

    environment {
        AWS_DEFAULT_REGION = 'ap-northeast-1'
        EKS_CLUSTER_NAME = 'dev-eks-ap-northeast-1'
        KUBECONFIG = '/tmp/kubeconfig'
        DOCKER_IMAGE = 'nuitciel/petclinic:latest'
        GIT_REPO_URL = 'https://github.com/cccr-pass1/Petclinic.git'
        ARGOCD_SERVER = 'argocd.cccr-opensource.com'
        K8S_NAMESPACE = 'cccr-project'
        ARGOCD_APP_NAME = 'cccr-pass1'
        GIT_USER_EMAIL = 'gongdae1359@gmail.com'
        GIT_USER_NAME = 'gongd135'
    }

    stages {
        stage('Checkout') {
            steps {
                git url: "${GIT_REPO_URL}", branch: 'main', credentialsId: 'github-creds'
            }
        }

        stage('Update kubeconfig and Verify Connection') {
            steps {
                container('aws-kubectl') {
                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-credentials']]) {
                        sh """
                        aws --version
                        kubectl version --client
                        aws eks --region ${AWS_DEFAULT_REGION} update-kubeconfig --name ${EKS_CLUSTER_NAME} --kubeconfig ${KUBECONFIG}
                        kubectl --kubeconfig=${KUBECONFIG} get nodes
                        """
                    }
                }
            }
        }

        stage('Verify k8s/deployment.yaml') {
            steps {
                sh '''
                echo "Checking if k8s/deployment.yaml exists..."
                if [ ! -f k8s/deployment.yaml ]; then
                    echo "Error: k8s/deployment.yaml not found!"
                    exit 1
                fi
                '''
            }
        }

        stage('Update Kubernetes Manifests') {
            steps {
                withCredentials([string(credentialsId: 'github-pat', variable: 'GITHUB_TOKEN')]) {
                    sh """
                    # ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
                    sed -i 's#image:.*#image: ${DOCKER_IMAGE}#g' k8s/deployment.yaml
                    
                    # Git ì„¤ì •
                    git config user.email "${GIT_USER_EMAIL}"
                    git config user.name "${GIT_USER_NAME}"
                    git add k8s/deployment.yaml
                    
                    # ë³€ê²½ ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
                    if ! git diff --cached --quiet; then
                        git commit -m "Update image to ${DOCKER_IMAGE}"
                        
                        # ì›ê²© ì €ì¥ì†Œ URL ì„¤ì • (í† í°ì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦)
                        git remote set-url origin https://${GIT_USER_NAME}:${GITHUB_TOKEN}@github.com/cccr-pass1/Petclinic.git
                        
                        # ë³€ê²½ ì‚¬í•­ í‘¸ì‹œ
                        git push origin main
                    else
                        echo "ì»¤ë°‹í•  ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
                    fi
                    """
                }
            }
        }

        stage('Deploy with ArgoCD') {
            steps {
                withCredentials([
                    usernamePassword(credentialsId: 'argocd-creds', usernameVariable: 'ARGOCD_USER', passwordVariable: 'ARGOCD_PASS'),
                    usernamePassword(credentialsId: 'github-repo-creds', usernameVariable: 'GITHUB_REPO_USER', passwordVariable: 'GITHUB_REPO_PASS')
                ]) {
                    sh """
                    set -e  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨

                    # ArgoCD CLI ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜ (í˜„ì¬ ë””ë ‰í† ë¦¬ì— ì„¤ì¹˜)
                    curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
                    chmod +x argocd

                    # ArgoCD ë¡œê·¸ì¸
                    ./argocd login ${ARGOCD_SERVER} --username $ARGOCD_USER --password $ARGOCD_PASS --insecure

                    # GitHub Repository ì¶”ê°€
                    ./argocd repo add https://github.com/cccr-pass1/Petclinic.git --username $GITHUB_REPO_USER --password $GITHUB_REPO_PASS

                    # ì• í”Œë¦¬ì¼€ì´ì…˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                    if ! ./argocd app get ${ARGOCD_APP_NAME} > /dev/null 2>&1; then
                        echo "Application '${ARGOCD_APP_NAME}' not found. Creating application..."
                        ./argocd app create ${ARGOCD_APP_NAME} \
                            --repo ${GIT_REPO_URL} \
                            --path k8s \
                            --dest-server https://kubernetes.default.svc \
                            --dest-namespace ${K8S_NAMESPACE} \
                            --sync-policy automated \
                            --self-heal \
                            --auto-prune
                    else
                        echo "Application '${ARGOCD_APP_NAME}' already exists."
                    fi

                    # ì• í”Œë¦¬ì¼€ì´ì…˜ ë™ê¸°í™”
                    ./argocd app sync ${ARGOCD_APP_NAME} --grpc-web
                    """
                }
            }
        }
    }

    post {
        success {
            slackSend (
                channel: '#backend',
                message: "ğŸ‰ íŒŒì´í”„ë¼ì¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸš€ \nì´ë¯¸ ë°°í¬ëœ ì´ë¯¸ì§€: ${DOCKER_IMAGE}",
                color: 'good'
            )
        }
        failure {
            slackSend (
                channel: '#backend',
                message: "â— íŒŒì´í”„ë¼ì¸ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ğŸ˜¢ \ní™•ì¸í•´ì£¼ì„¸ìš”.",
                color: 'danger'
            )
        }
    }
}
